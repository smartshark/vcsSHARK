

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>pyvcsshark.parser.gitparser &mdash; vcsSHARK 2.0.7 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> vcsSHARK
          

          
            
            <img src="../../../_static/SmartSHARK_read_the_docs_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extension.html">2. How to Extend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">3. API Documentation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">vcsSHARK</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pyvcsshark.parser.gitparser</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyvcsshark.parser.gitparser</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">pyvcsshark.parser.baseparser</span> <span class="kn">import</span> <span class="n">BaseParser</span>
<span class="kn">import</span> <span class="nn">pygit2</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>

<span class="kn">from</span> <span class="nn">pyvcsshark.parser.models</span> <span class="kn">import</span> <span class="n">BranchModel</span><span class="p">,</span> <span class="n">PeopleModel</span><span class="p">,</span> <span class="n">TagModel</span><span class="p">,</span> <span class="n">FileModel</span><span class="p">,</span> <span class="n">CommitModel</span><span class="p">,</span> <span class="n">Hunk</span><span class="p">,</span> <span class="n">BranchTipModel</span>


<div class="viewcode-block" id="GitParser"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.GitParser">[docs]</a><span class="k">class</span> <span class="nc">GitParser</span><span class="p">(</span><span class="n">BaseParser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Parser for git repositories. The general parsing process is described in</span>
<span class="sd">    :func:`pyvcsshark.parser.gitparser.GitParser.parse`.</span>
<span class="sd">    </span>
<span class="sd">    :property SIMILARITY_THRESHOLD: sets the threshold for deciding if a file is similar to another. Default: 50%</span>
<span class="sd">    :func:`multiprocessing.cpu_count()`.</span>
<span class="sd">    :property repository: object of class :class:`pygit2.Repository`, which represents the repository</span>
<span class="sd">    :property commits_to_be_processed: dictionary that is set up the following way: \</span>
<span class="sd">    commits_to_be_processed = {&#39;&lt;revisionHash&gt;&#39; : {&#39;branches&#39; : set(), &#39;tags&#39; : []}}, where &lt;revisionHash&gt; must be\</span>
<span class="sd">    replaced with the actual hash. Therefore, this dictionary holds information about every revision and which branches\</span>
<span class="sd">     this revision belongs to and which tags it has.</span>
<span class="sd">    :property logger: logger, which is acquired via logging.getLogger(&quot;parser&quot;)</span>
<span class="sd">    :property datastore: datastore, where the commits should be saved to</span>
<span class="sd">    :property commit_queue: object of class :class:`multiprocessing.JoinableQueue`, where commits are stored in that\</span>
<span class="sd">    can be parsed</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Includes rename and copy threshold, 50% is the default git threshold</span>
    <span class="n">SIMILARITY_THRESHOLD</span> <span class="o">=</span> <span class="mi">50</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repository</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commits_to_be_processed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;parser&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datastore</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">commit_queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">JoinableQueue</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">repository_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;git&#39;</span>

<div class="viewcode-block" id="GitParser.get_project_url"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.GitParser.get_project_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_project_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the url of the project, which is processed &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;local/&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">remotes</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">url</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># repository is only local</span>
            <span class="k">pass</span>
        
        <span class="k">return</span> <span class="n">url</span></div>

<div class="viewcode-block" id="GitParser.finalize"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.GitParser.finalize">[docs]</a>    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finalization process for parser&quot;&quot;&quot;</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="GitParser.detect"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.GitParser.detect">[docs]</a>    <span class="k">def</span> <span class="nf">detect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repository_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to detect the repository, if its not there an exception is raised and therfore false can be returned&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">discovered_path</span> <span class="o">=</span> <span class="n">pygit2</span><span class="o">.</span><span class="n">discover_repository</span><span class="p">(</span><span class="n">repository_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repository</span> <span class="o">=</span> <span class="n">pygit2</span><span class="o">.</span><span class="n">Repository</span><span class="p">(</span><span class="n">discovered_path</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="GitParser.add_branch"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.GitParser.add_branch">[docs]</a>    <span class="k">def</span> <span class="nf">add_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commit_hash</span><span class="p">,</span> <span class="n">branch</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Does two things: First it adds the commitHash to the commitqueue, so that the parsing processes can process this commit. Second it</span>
<span class="sd">        creates objects of type :class:`pyvcsshark.parser.models.BranchModel` and stores it in the dictionary.</span>

<span class="sd">        :param commit_hash: revision hash of the commit to be processed</span>
<span class="sd">        :param branch: branch that should be added for the commit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">string_commit_hash</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">commit_hash</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">branch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">branch_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">branch_model</span> <span class="o">=</span> <span class="n">BranchModel</span><span class="p">(</span><span class="n">branch</span><span class="p">)</span>

        <span class="c1"># If the commit is already in the dict, we only need to append the branch (because then it was already parsed)</span>
        <span class="k">if</span> <span class="n">string_commit_hash</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commits_to_be_processed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commits_to_be_processed</span><span class="p">[</span><span class="n">string_commit_hash</span><span class="p">][</span><span class="s1">&#39;branches&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">branch_model</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commit_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">string_commit_hash</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commits_to_be_processed</span><span class="p">[</span><span class="n">string_commit_hash</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;branches&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">branch_model</span><span class="p">},</span> <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">[]}</span></div>

<div class="viewcode-block" id="GitParser.add_tag"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.GitParser.add_tag">[docs]</a>    <span class="k">def</span> <span class="nf">add_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tagged_commit</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">tag_object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates objects of type :class:`pyvcsshark.parser.models.TagModel` and stores it in the dictionary mentioned above.</span>

<span class="sd">        :param tagged_commit: revision hash of the commit to be processed</span>
<span class="sd">        :param tag_name: name of the tag that should be added</span>
<span class="sd">        :param tag_object: in git it is possible to annotate tags. If a tag is annotated,</span>
<span class="sd">         we get a tag object of class :class:`pygit2.Tag`</span>


<span class="sd">        .. NOTE:: It can happen, that people committed to a tag and therefore created \</span>
<span class="sd">        a &quot;tag-branch&quot; which is normally not possible in git. Therefore, we go through all tags and check \</span>
<span class="sd">        if they respond to a commit, which is already in the dictionary. \</span>
<span class="sd">        If **yes** -&gt; we **tag** that commit \</span>
<span class="sd">        If **no** -&gt; we **ignore** it</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">commit_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tagged_commit</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">tag_name</span> <span class="o">=</span> <span class="n">tag_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># If we have an annotated tag, get all the information we can out of it</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tag_object</span><span class="p">,</span> <span class="n">pygit2</span><span class="o">.</span><span class="n">Tag</span><span class="p">):</span>

            <span class="c1"># in some cases (jspwiki) there are taggers where the name or email contains non utf-8 chars.</span>
            <span class="c1"># In these cases we replace them with the utf-8 replacement character</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">tag_object</span><span class="o">.</span><span class="n">tagger</span><span class="o">.</span><span class="n">name</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">tag_object</span><span class="o">.</span><span class="n">tagger</span><span class="o">.</span><span class="n">raw_name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">email</span> <span class="o">=</span> <span class="n">tag_object</span><span class="o">.</span><span class="n">tagger</span><span class="o">.</span><span class="n">email</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">email</span> <span class="o">=</span> <span class="n">tag_object</span><span class="o">.</span><span class="n">tagger</span><span class="o">.</span><span class="n">raw_email</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span>

            <span class="n">people_model</span> <span class="o">=</span> <span class="n">PeopleModel</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
            <span class="n">tag_model</span> <span class="o">=</span> <span class="n">TagModel</span><span class="p">(</span><span class="n">tag_name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tag_object</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">people_model</span><span class="p">,</span>
                                 <span class="n">tag_object</span><span class="o">.</span><span class="n">tagger</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">tag_object</span><span class="o">.</span><span class="n">tagger</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tag_model</span> <span class="o">=</span> <span class="n">TagModel</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)</span>

        <span class="c1"># As it can happen that we have commits with tags that are not on any branch (e.g. project Zookeeper), we need</span>
        <span class="c1"># to take care of that here</span>
        <span class="k">if</span> <span class="n">commit_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commits_to_be_processed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commits_to_be_processed</span><span class="p">[</span><span class="n">commit_id</span><span class="p">][</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag_model</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commits_to_be_processed</span><span class="p">[</span><span class="n">commit_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;branches&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">([]),</span> <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">tag_model</span><span class="p">]}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commit_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">commit_id</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_set_branch_tips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branches</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This sets the tips (last commits) for all remote branches.</span>

<span class="sd">        Normally we would also multiprocess here but as this is a quick operation we do not need</span>
<span class="sd">        the additional overhead of defining a new BranchParserProcess.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">branches</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">branch_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">branches</span><span class="o">.</span><span class="n">remote</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">branch_name</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;origin/&#39;</span><span class="p">):</span>
                <span class="n">branch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">branches</span><span class="o">.</span><span class="n">remote</span><span class="p">[</span><span class="n">branch_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">branch_name</span> <span class="o">!=</span> <span class="s1">&#39;origin/HEAD&#39;</span><span class="p">:</span>
                    <span class="c1"># print(&#39;head: {}&#39;.format(branch.target.replace(&#39;refs/remotes/&#39;, &#39;&#39;))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">branch_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">branch</span><span class="o">.</span><span class="n">target</span><span class="p">),</span> <span class="s1">&#39;is_origin_head&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

        <span class="c1"># set origin_head we know its there and that it has a target that we also know</span>
        <span class="n">om</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="s1">&#39;origin/HEAD&#39;</span><span class="p">]</span>
        <span class="n">om_target</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;refs/remotes/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">om_target</span><span class="p">][</span><span class="s1">&#39;is_origin_head&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="GitParser.initialize"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.GitParser.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the parser. It gets all the branch and tag information and puts it into two different</span>
<span class="sd">        locations: First the commit id is put into the commitqueue for the processing with the parsing processes.</span>
<span class="sd">        Second a dictionary is created, which holds the information of which branches a commit is on and which tags it</span>
<span class="sd">        has</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get all references (branches, tags)</span>
        <span class="n">references</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">listall_references</span><span class="p">())</span>

        <span class="c1"># Get all tags</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^refs/tags&#39;</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">listall_references</span><span class="p">()))</span>

        <span class="c1"># Get all branches</span>
        <span class="n">branches</span> <span class="o">=</span> <span class="n">references</span> <span class="o">-</span> <span class="n">tags</span>

        <span class="c1"># set all tips for every branch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_branch_tips</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting branch information...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting information from branch </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">branch</span><span class="p">))</span>
            <span class="n">commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">lookup_reference</span><span class="p">(</span><span class="n">branch</span><span class="p">)</span><span class="o">.</span><span class="n">peel</span><span class="p">()</span>
            <span class="c1"># Walk through every child</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">commit</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                              <span class="n">pygit2</span><span class="o">.</span><span class="n">GIT_SORT_TIME</span> <span class="o">|</span> <span class="n">pygit2</span><span class="o">.</span><span class="n">GIT_SORT_TOPOLOGICAL</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_branch</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting tags...&quot;</span><span class="p">)</span>
        <span class="c1"># Walk through every tag and put the information in the dictionary via the addtag method</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">lookup_reference</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="n">tag_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="p">[</span><span class="n">reference</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">hex</span><span class="p">]</span>
            <span class="n">tagged_commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">lookup_reference</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span><span class="o">.</span><span class="n">peel</span><span class="p">()</span>

            <span class="c1"># we exclude Blobs</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tagged_commit</span><span class="p">,</span> <span class="n">pygit2</span><span class="o">.</span><span class="n">Blob</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_tag</span><span class="p">(</span><span class="n">tagged_commit</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">tag_object</span><span class="p">)</span>

            <span class="c1"># The tagged_commit can have children that are not on any branch, but we may need it anyway --&gt; collect it</span>
            <span class="c1"># and add it only if we have not collected it before</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tagged_commit</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pygit2</span><span class="o">.</span><span class="n">GIT_SORT_TIME</span> <span class="o">|</span> <span class="n">pygit2</span><span class="o">.</span><span class="n">GIT_SORT_TOPOLOGICAL</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commits_to_be_processed</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_branch</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># we may hit a tag that does not point to a commit but to a blob, therefore we can not walk over it until libgit implements this</span>
                <span class="c1"># see: https://github.com/libgit2/libgit2/issues/3595</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;ValueError: object is not a committish&#39;</span><span class="p">:</span>  <span class="c1"># we do not bail on this we just ignore tags to blobs</span>
                    <span class="k">raise</span></div>

<div class="viewcode-block" id="GitParser.parse"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.GitParser.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repository_path</span><span class="p">,</span> <span class="n">datastore</span><span class="p">,</span> <span class="n">cores_per_job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parses the repository, which is located at the repository_path and save the parsed commits in the</span>
<span class="sd">        datastore, by calling the :func:`pyvcsshark.datastores.basestore.BaseStore.add_commit` method of the chosen</span>
<span class="sd">        datastore. It mostly uses pygit2 (see: http://www.pygit2.org/).</span>
<span class="sd">        </span>
<span class="sd">        The parsing process is divided into several steps:</span>
<span class="sd">        </span>
<span class="sd">            1. A list of all branches and tags are created</span>
<span class="sd">            2. All branches and tags are parsed. So we create dictionary of all commits with their corresponding tags\</span>
<span class="sd">            and branches and add all revision hashes to the commitqueue</span>
<span class="sd">            3. Add the poison pills for terminating of the parsing process to the commit_queue</span>
<span class="sd">            4. Create processes of class :class:`pyvcsshark.parser.gitparser.CommitParserProcess`, which parse all\</span>
<span class="sd">            commits.</span>
<span class="sd">        </span>
<span class="sd">        :param repository_path: Path to the repository</span>
<span class="sd">        :param datastore: Datastore used to save the data to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datastore</span> <span class="o">=</span> <span class="n">datastore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting parsing process...&quot;</span><span class="p">)</span>

        <span class="c1"># first we want the branches queue filled</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datastore</span><span class="o">.</span><span class="n">add_branch</span><span class="p">(</span><span class="n">BranchTipModel</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;is_origin_head&#39;</span><span class="p">]))</span>

        <span class="c1"># Set up the poison pills</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cores_per_job</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commit_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Parsing all commits of the queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Parsing commits...&quot;</span><span class="p">)</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cores_per_job</span><span class="p">):</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">CommitParserProcess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commit_queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commits_to_be_processed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datastore</span><span class="p">,</span>
                                         <span class="n">lock</span><span class="p">)</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">commit_queue</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Parsing complete...&quot;</span><span class="p">)</span>

        <span class="k">return</span></div></div>


<div class="viewcode-block" id="CommitParserProcess"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.CommitParserProcess">[docs]</a><span class="k">class</span> <span class="nc">CommitParserProcess</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A process, which inherits from :class:`multiprocessing.Process`, that will parse the branches it </span>
<span class="sd">    gets from the queue and call the :func:`pyvcsshark.datastores.basestore.BaseStore.addCommit` function to add</span>
<span class="sd">    the commits</span>
<span class="sd">    </span>
<span class="sd">    :property logger: logger acquired by calling logging.getLogger(&quot;parser&quot;)</span>
<span class="sd">    </span>
<span class="sd">    :param queue: queue, where the different commithashes are stored in</span>
<span class="sd">    :param commits_to_be_processed: dictionary, which contains information about the branches and tags of each commit</span>
<span class="sd">    :param repository: repository object of type :class:`pygit2.Repository`</span>
<span class="sd">    :param datastore: object, that is a subclass of :class:`pyvcsshark.datastores.basestore.BaseStore`</span>
<span class="sd">    :param lock: lock that is used, so that only one process at a time is calling \</span>
<span class="sd">    the :func:`pyvcsshark.datastores.basestore.BaseStore.addCommit` function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">commits_to_be_processed</span><span class="p">,</span> <span class="n">repository</span><span class="p">,</span> <span class="n">datastore</span><span class="p">,</span> <span class="n">lock</span><span class="p">):</span>
        <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commits_to_be_processed</span> <span class="o">=</span> <span class="n">commits_to_be_processed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datastore</span> <span class="o">=</span> <span class="n">datastore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;parser&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repository</span> <span class="o">=</span> <span class="n">repository</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">lock</span>
        
<div class="viewcode-block" id="CommitParserProcess.run"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.CommitParserProcess.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The process gets a commit out of the queue and processes it.</span>
<span class="sd">        We use the poisonous pill technique here. Means, our queue has #Processes times &quot;None&quot; in it in the end.</span>
<span class="sd">        If a process encounters that None, he will stop and terminate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">next_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="c1"># If process pulls the poisoned pill, he exits</span>
            <span class="k">if</span> <span class="n">next_task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="n">commitHash</span> <span class="o">=</span> <span class="n">pygit2</span><span class="o">.</span><span class="n">Oid</span><span class="p">(</span><span class="nb">hex</span><span class="o">=</span><span class="n">next_task</span><span class="p">)</span>
            <span class="n">commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="p">[</span><span class="n">commitHash</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_commit</span><span class="p">(</span><span class="n">commit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="CommitParserProcess.parse_commit"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.CommitParserProcess.parse_commit">[docs]</a>    <span class="k">def</span> <span class="nf">parse_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Function for parsing a commit.</span>

<span class="sd">        1. changedFiles are created (type: list of :class:`pyvcsshark.parser.models.FileModel`)</span>
<span class="sd">        2. author and commiter are created (type: :class:`pyvcsshark.parser.models.PeopleModel`)</span>
<span class="sd">        3. parents are added (list of strings)</span>
<span class="sd">        4. commit model is created (type: :class:`pyvcsshark.parser.models.CommitModel`)</span>
<span class="sd">        5. :func:`pyvcsshark.datastores.basestore.BaseStore.addCommit` is called</span>

<span class="sd">        :param commit: commit object of type :class:`pygit2.Commit`</span>

<span class="sd">        .. NOTE:: The call to :func:`pyvcsshark.datastores.basestore.BaseStore.addCommit` is thread/process safe, as a\</span>
<span class="sd">        lock is used to regulate the calls</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># we do not want Blobs (for now)</span>
        <span class="k">if</span> <span class="n">commit</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;Blob&#39;</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">commits_to_be_processed</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">commit</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span>
            <span class="k">return</span>

        <span class="c1"># If there are parents, we need to get the normal changed files, if not we need to get the files for initial</span>
        <span class="c1"># commit</span>
        <span class="k">if</span> <span class="n">commit</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
            <span class="n">changed_files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">commit</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
                <span class="n">changed_files</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_changed_files_with_similiarity</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">commit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">changed_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_changed_files_for_initial_commit</span><span class="p">(</span><span class="n">commit</span><span class="p">)</span>

        <span class="n">string_commit_hash</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">commit</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Create the different models</span>
        <span class="n">author_model</span> <span class="o">=</span> <span class="n">PeopleModel</span><span class="p">(</span><span class="n">commit</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">commit</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
        <span class="n">committer_model</span> <span class="o">=</span> <span class="n">PeopleModel</span><span class="p">(</span><span class="n">commit</span><span class="o">.</span><span class="n">committer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">commit</span><span class="o">.</span><span class="n">committer</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
        <span class="n">parent_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">parentId</span><span class="p">)</span> <span class="k">for</span> <span class="n">parentId</span> <span class="ow">in</span> <span class="n">commit</span><span class="o">.</span><span class="n">parent_ids</span><span class="p">]</span>
        <span class="n">commit_model</span> <span class="o">=</span> <span class="n">CommitModel</span><span class="p">(</span><span class="n">string_commit_hash</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commits_to_be_processed</span><span class="p">[</span><span class="n">string_commit_hash</span><span class="p">][</span><span class="s1">&#39;branches&#39;</span><span class="p">],</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">commits_to_be_processed</span><span class="p">[</span><span class="n">string_commit_hash</span><span class="p">][</span><span class="s1">&#39;tags&#39;</span><span class="p">],</span> <span class="n">parent_ids</span><span class="p">,</span>
                                   <span class="n">author_model</span><span class="p">,</span> <span class="n">committer_model</span><span class="p">,</span> <span class="n">commit</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">changed_files</span><span class="p">,</span> <span class="n">commit</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                                   <span class="n">commit</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">commit</span><span class="o">.</span><span class="n">committer</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">commit</span><span class="o">.</span><span class="n">committer</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
        
        <span class="c1"># Make sure, that addCommit is only called by one process at a time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datastore</span><span class="o">.</span><span class="n">add_commit</span><span class="p">(</span><span class="n">commit_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">commits_to_be_processed</span><span class="p">[</span><span class="n">string_commit_hash</span><span class="p">]</span></div>

<div class="viewcode-block" id="CommitParserProcess.create_hunks"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.CommitParserProcess.create_hunks">[docs]</a>    <span class="k">def</span> <span class="nf">create_hunks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hunks</span><span class="p">,</span> <span class="n">initial_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the diff in the unified format (see: https://en.wikipedia.org/wiki/Diff#Unified_format)</span>

<span class="sd">        If we have the initial commit, we need to turn around the hunk.* attributes.</span>

<span class="sd">        :param hunks: list of objects of class :class:`pygit2.DiffHunk`</span>
<span class="sd">        :param initial_commit: indicates if we have an initial commit</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">list_of_hunks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">hunk</span> <span class="ow">in</span> <span class="n">hunks</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">initial_commit</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">hunk</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
                    <span class="n">output</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="n">gen_hunk</span> <span class="o">=</span> <span class="n">Hunk</span><span class="p">(</span><span class="n">hunk</span><span class="o">.</span><span class="n">old_start</span><span class="p">,</span> <span class="n">hunk</span><span class="o">.</span><span class="n">old_lines</span><span class="p">,</span> <span class="n">hunk</span><span class="o">.</span><span class="n">new_start</span><span class="p">,</span> <span class="n">hunk</span><span class="o">.</span><span class="n">new_lines</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">hunk</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
                    <span class="n">output</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="n">gen_hunk</span> <span class="o">=</span> <span class="n">Hunk</span><span class="p">(</span><span class="n">hunk</span><span class="o">.</span><span class="n">new_start</span><span class="p">,</span> <span class="n">hunk</span><span class="o">.</span><span class="n">new_lines</span><span class="p">,</span> <span class="n">hunk</span><span class="o">.</span><span class="n">old_start</span><span class="p">,</span> <span class="n">hunk</span><span class="o">.</span><span class="n">old_lines</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
            <span class="n">list_of_hunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gen_hunk</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">list_of_hunks</span></div>

<div class="viewcode-block" id="CommitParserProcess.get_changed_files_for_initial_commit"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.CommitParserProcess.get_changed_files_for_initial_commit">[docs]</a>    <span class="k">def</span> <span class="nf">get_changed_files_for_initial_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Special function for the initial commit, as we need to diff against the empty tree. Creates</span>
<span class="sd">        the changed files list, where objects of class :class:`pyvcsshark.parser.models.FileModel` are added.</span>
<span class="sd">        For every changed file in the initial commit.</span>

<span class="sd">        :param commit: commit of type :class:`pygit2.Commit`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">changed_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">commit</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">diff_to_tree</span><span class="p">(</span><span class="n">context_lines</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">interhunk_lines</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">:</span>
            <span class="n">changed_file</span> <span class="o">=</span> <span class="n">FileModel</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">old_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">old_file</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                     <span class="n">patch</span><span class="o">.</span><span class="n">line_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">patch</span><span class="o">.</span><span class="n">line_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                     <span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">is_binary</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">create_hunks</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">hunks</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
            <span class="n">changed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">changed_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">changed_files</span></div>

<div class="viewcode-block" id="CommitParserProcess.get_changed_files_with_similiarity"><a class="viewcode-back" href="../../../api.html#pyvcsshark.parser.gitparser.CommitParserProcess.get_changed_files_with_similiarity">[docs]</a>    <span class="k">def</span> <span class="nf">get_changed_files_with_similiarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">commit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates a list of changed files of the class :class:`pyvcsshark.parser.models.FileModel`. For every</span>
<span class="sd">        changed file in the commit such an object is created. Furthermore, hunks are saved an each file is tested for</span>
<span class="sd">        similarity to detect copy and move operations</span>
<span class="sd">        </span>
<span class="sd">        :param parent: Object of class :class:`pygit2.Commit`, that represents the parent commit</span>
<span class="sd">        :param commit: Object of class :class:`pygit2.Commit`, that represents the child commit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">changed_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">commit</span><span class="p">,</span> <span class="n">context_lines</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">interhunk_lines</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                            
        <span class="n">opts</span> <span class="o">=</span> <span class="n">pygit2</span><span class="o">.</span><span class="n">GIT_DIFF_FIND_RENAMES</span> <span class="o">|</span> <span class="n">pygit2</span><span class="o">.</span><span class="n">GIT_DIFF_FIND_COPIES</span>
        <span class="n">diff</span><span class="o">.</span><span class="n">find_similar</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">GitParser</span><span class="o">.</span><span class="n">SIMILARITY_THRESHOLD</span><span class="p">,</span> <span class="n">GitParser</span><span class="o">.</span><span class="n">SIMILARITY_THRESHOLD</span><span class="p">)</span>

        <span class="n">already_checked_file_paths</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">:</span>

            <span class="c1"># Only if the filepath was not processed before, add new file</span>
            <span class="k">if</span> <span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">new_file</span><span class="o">.</span><span class="n">path</span> <span class="ow">in</span> <span class="n">already_checked_file_paths</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Check change mode</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span>
            <span class="k">if</span> <span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span>
            <span class="k">elif</span> <span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;D&#39;</span>
            <span class="k">elif</span> <span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;M&#39;</span>
            <span class="k">elif</span> <span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;R&#39;</span>
            <span class="k">elif</span> <span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;C&#39;</span>
            <span class="k">elif</span> <span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
            <span class="k">elif</span> <span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span>
            <span class="k">elif</span> <span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span>

            <span class="n">changed_file</span> <span class="o">=</span> <span class="n">FileModel</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">new_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">new_file</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                     <span class="n">patch</span><span class="o">.</span><span class="n">line_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">patch</span><span class="o">.</span><span class="n">line_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                     <span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">is_binary</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">create_hunks</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">hunks</span><span class="p">),</span> <span class="n">parent_revision_hash</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            
            <span class="c1"># only add oldpath if file was copied/renamed</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">]:</span>
                <span class="n">changed_file</span><span class="o">.</span><span class="n">oldPath</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">old_file</span><span class="o">.</span><span class="n">path</span>
    
            <span class="n">already_checked_file_paths</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">new_file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">changed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">changed_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">changed_files</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017, Fabian Trautsch.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>